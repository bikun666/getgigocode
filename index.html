<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>éªŒè¯ç åˆ—è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap">
  <style>
    body { background: #f8fafc; color: #1e293b; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif; padding: 20px; margin: 0; }
    .header { display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 16px 24px; margin-bottom: 24px; }
    .header h1 { font-size: 22px; font-weight: 700; color: #3b82f6; }
    .copy-btn { background: #3b82f6; color: #fff; border: none; border-radius: 10px; padding: 8px 18px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .copy-btn:hover { background: #2563eb; }
    .copy-btn.done { background: #22c55e !important; color: #fff; }
    .container { max-width: 800px; margin: auto; }
    .item { background: white; border-left: 6px solid #3b82f6; padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.06); margin-bottom: 16px; position: relative; }
    .item.highlight { background: #fff7b2; border-color: #fbbf24; }
    .latest-tip { position: absolute; top: 0; right: 0; background: red; color: white; font-size: 14px; font-weight: 600; padding: 6px 12px; border-bottom-left-radius: 12px; }
    .line { font-size: 18px; font-weight: 600; }
    .code { color: #3b82f6; font-weight: 800; font-size: 22px; }
    .meta { font-size: 13px; color: gray; margin: 10px 0; }
    details summary { cursor: pointer; color: #3b82f6; font-weight: 600; margin-top: 8px; }
    pre { background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 13px; overflow: auto; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>éªŒè¯ç åˆ—è¡¨</h1></div>
    <div id="list"><div class="empty">æ­£åœ¨åŠ è½½ä¸­...</div></div>
  </div>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbz2qdfGi8gI2B1amPKMJXfv18q91U3vuPep5JZY9iyRqOJ5m-DXpZsUBZCt2BumylbQ/exec';

    function formatDate(iso) {
      return new Date(iso).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
    }

    function renderList(data) {
      const listEl = document.getElementById("list");
      listEl.innerHTML = "";

      // 1. å…ˆæŒ‰ä¸»é¢˜ç­›å‡ºæ‰€æœ‰éªŒè¯ç æ¡ç›®
      let items = data.filter(item =>
        (item["é‚®ä»¶ä¸»é¢˜"]||"").includes("ã€GENDA IDã€‘èªè¨¼ã‚³ãƒ¼ãƒ‰")
      );
      if (!items.length) {
        listEl.innerHTML = `<div class="empty">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®â€¦</div>`;
        return;
      }

      // 2. é€šè¿‡åˆ—ç´¢å¼•æ‹¿åˆ° G åˆ—å¯¹åº”çš„ keyï¼ˆç¬¬7åˆ—ï¼Œç´¢å¼•6ï¼‰
      const headers = Object.keys(data[0]);
      const gKey = headers[6];  

      // 3. æ”¶é›† G åˆ—æ‰€æœ‰è¡Œçš„éç©ºå€¼ï¼Œå»é‡åä½œä¸ºç™½åå•
      const allowList = Array.from(new Set(
        data.map(row => row[gKey]).filter(v => v)
      ));

      // 4. å¦‚æœç™½åå•æœ‰å†…å®¹ï¼Œå°±åªä¿ç•™æ”¶ä»¶äººåœ¨åå•é‡Œçš„æ¡ç›®
      if (allowList.length > 0) {
        items = items.filter(item => allowList.includes(item["æ”¶ä»¶äºº"]));
        if (!items.length) {
          listEl.innerHTML = `<div class="empty">ç™½åå•é‡Œæ²¡æœ‰éªŒè¯ç è®°å½•â€¦</div>`;
          return;
        }
      }

      // 5. æ¸²æŸ“å‰ 10 æ¡
      items.slice(0, 10).forEach((item, idx) => {
        const isLatest = idx === 0;
        const code = item["éªŒè¯ç "];
        const hasCode = code && code !== "-";
        listEl.insertAdjacentHTML('beforeend', `
          <div class="item ${isLatest?'highlight':''}">
            ${isLatest?`<div class="latest-tip">ğŸŸ¡ æœ€æ–°</div>`:""}
            <div class="line">
              ${item["æ”¶ä»¶äºº"]}<br>éªŒè¯ç ï¼š
              ${hasCode
                ? `<span class="code">${code}</span>
                   <button class="copy-btn" data-code="${code}">å¤åˆ¶</button>`
                : `<span class="code">(æœªæ‰¾åˆ°)</span>`}
            </div>
            <div class="meta">${formatDate(item["æ¥æ”¶æ—¶é—´"])}</div>
            <details>
              <summary>æŸ¥çœ‹åŸæ–‡</summary>
              <div>
                ${item["é‚®ä»¶ä¸»é¢˜"]?`ä»¶åï¼š${item["é‚®ä»¶ä¸»é¢˜"]}<br>`:""}
                ${item["å‘ä»¶äºº"]?`å‘ä»¶äººï¼š${item["å‘ä»¶äºº"]}<br>`:""}
                <pre>${item["æ­£æ–‡æ‘˜è¦"]||""}</pre>
              </div>
            </details>
          </div>`);
      });

      // 6. ç»‘å®šå¤åˆ¶æŒ‰é’®
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(btn.dataset.code);
            btn.textContent = 'å·²å¤åˆ¶';
            btn.classList.add('done');
            setTimeout(() => {
              btn.textContent = 'å¤åˆ¶';
              btn.classList.remove('done');
            }, 2000);
          } catch {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + btn.dataset.code);
          }
        });
      });
    }

    // æ‹‰æ•°æ®å¹¶æ¸²æŸ“ï¼Œ2 ç§’è‡ªåŠ¨åˆ·æ–°
    async function loadData() {
      try {
        const res = await fetch(apiURL);
        const { status, data } = await res.json();
        if (status === "OK" && Array.isArray(data)) {
          renderList(data);
        }
      } catch (e) {
        console.error("åŠ è½½å¤±è´¥", e);
      }
    }
    loadData();
    setInterval(loadData, 2000);
  </script>
</body>
</html>
