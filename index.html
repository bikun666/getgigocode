<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>验证码列表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap">
  <style>
    body { background: #f8fafc; color: #1e293b; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif; padding: 20px; margin: 0; }
    .header { display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 16px 24px; margin-bottom: 24px; }
    .header h1 { font-size: 22px; font-weight: 700; color: #3b82f6; }
    .copy-btn { background: #3b82f6; color: #fff; border: none; border-radius: 10px; padding: 8px 18px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .copy-btn:hover { background: #2563eb; }
    .copy-btn.done { background: #22c55e !important; color: #fff; }
    .container { max-width: 800px; margin: auto; }
    .item { background: white; border-left: 6px solid #3b82f6; padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.06); margin-bottom: 16px; position: relative; }
    .item.highlight { background: #fff7b2; border-color: #fbbf24; }
    .latest-tip { position: absolute; top: 0; right: 0; background: red; color: white; font-size: 14px; font-weight: 600; padding: 6px 12px; border-bottom-left-radius: 12px; }
    .line { font-size: 18px; font-weight: 600; }
    .code { color: #3b82f6; font-weight: 800; font-size: 22px; }
    .meta { font-size: 13px; color: gray; margin: 10px 0; }
    details summary { cursor: pointer; color: #3b82f6; font-weight: 600; margin-top: 8px; }
    pre { background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 13px; overflow: auto; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>验证码列表</h1></div>
    <div id="list"><div class="empty">正在加载中...</div></div>
  </div>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbz2qdfGi8gI2B1amPKMJXfv18q91U3vuPep5JZY9iyRqOJ5m-DXpZsUBZCt2BumylbQ/exec';

    function formatDate(iso) {
      return new Date(iso).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
    }

    function renderList(data) {
      const listEl = document.getElementById("list");
      listEl.innerHTML = "";

      // 1. 先按主题筛出所有验证码条目
      let items = data.filter(item =>
        (item["邮件主题"]||"").includes("【GENDA ID】認証コード")
      );
      if (!items.length) {
        listEl.innerHTML = `<div class="empty">没有符合条件的数据…</div>`;
        return;
      }

      // 2. 通过列索引拿到 G 列对应的 key（第7列，索引6）
      const headers = Object.keys(data[0]);
      const gKey = headers[6];  

      // 3. 收集 G 列所有行的非空值，去重后作为白名单
      const allowList = Array.from(new Set(
        data.map(row => row[gKey]).filter(v => v)
      ));

      // 4. 如果白名单有内容，就只保留收件人在名单里的条目
      if (allowList.length > 0) {
        items = items.filter(item => allowList.includes(item["收件人"]));
        if (!items.length) {
          listEl.innerHTML = `<div class="empty">白名单里没有验证码记录…</div>`;
          return;
        }
      }

      // 5. 渲染前 10 条
      items.slice(0, 10).forEach((item, idx) => {
        const isLatest = idx === 0;
        const code = item["验证码"];
        const hasCode = code && code !== "-";
        listEl.insertAdjacentHTML('beforeend', `
          <div class="item ${isLatest?'highlight':''}">
            ${isLatest?`<div class="latest-tip">🟡 最新</div>`:""}
            <div class="line">
              ${item["收件人"]}<br>验证码：
              ${hasCode
                ? `<span class="code">${code}</span>
                   <button class="copy-btn" data-code="${code}">复制</button>`
                : `<span class="code">(未找到)</span>`}
            </div>
            <div class="meta">${formatDate(item["接收时间"])}</div>
            <details>
              <summary>查看原文</summary>
              <div>
                ${item["邮件主题"]?`件名：${item["邮件主题"]}<br>`:""}
                ${item["发件人"]?`发件人：${item["发件人"]}<br>`:""}
                <pre>${item["正文摘要"]||""}</pre>
              </div>
            </details>
          </div>`);
      });

      // 6. 绑定复制按钮
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(btn.dataset.code);
            btn.textContent = '已复制';
            btn.classList.add('done');
            setTimeout(() => {
              btn.textContent = '复制';
              btn.classList.remove('done');
            }, 2000);
          } catch {
            alert('复制失败，请手动复制：' + btn.dataset.code);
          }
        });
      });
    }

    // 拉数据并渲染，2 秒自动刷新
    async function loadData() {
      try {
        const res = await fetch(apiURL);
        const { status, data } = await res.json();
        if (status === "OK" && Array.isArray(data)) {
          renderList(data);
        }
      } catch (e) {
        console.error("加载失败", e);
      }
    }
    loadData();
    setInterval(loadData, 2000);
  </script>
</body>
</html>
