<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>éªŒè¯ç åˆ—è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- å­—ä½“ & æ ·å¼ -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap">
  <style>
    /* â€”â€” å…¨å±€ â€”â€” */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body {
      overflow-x: hidden;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background: #000; /* é»‘åº•æ›´è¡¬å‡ºç‰¹æ•ˆ */
      color: #fff;
      min-height: 100vh; position: relative;
    }
    /* â€”â€” ç‰¹æ•ˆç”»å¸ƒ â€”â€” */
    #particles-js,
    #glsl-canvas,
    #tsparticles {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -2;
    }
    /* glsl-canvas å åœ¨ particles ä¹‹ä¸Š */
    #glsl-canvas { z-index: -1; }

    /* â€”â€” å®¹å™¨ & å¡ç‰‡ â€”â€” */
    .container {
      position: relative; z-index: 1;
      max-width: 800px; margin: 0 auto; padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
    }
    .header {
      margin-bottom: 16px;
      padding: 20px; background: rgba(255,255,255,0.1);
      border-radius: 12px; text-align: center;
      cursor: move; /* Vanilla-Tilt ç”Ÿæ•ˆåŒºåŸŸ */
    }
    .header h1 {
      font-size: 2rem; font-weight: 800;
      background: linear-gradient(90deg,#3b82f6,#1d4ed8);
      -webkit-background-clip: text; background-clip: text;
      color: transparent;
      display: inline-block; position: relative;
    }
    /* SVG Logo */
    #logo { display: block; margin: 0 auto 12px; }

    .controls {
      display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
    }
    .refresh-btn, .mute-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 10px 16px; font-size: 1rem; font-weight: 600;
      border-radius: 8px; cursor: pointer; transition: transform .2s;
    }
    .refresh-btn {
      background: #2563eb; color: #fff; border: none;
    }
    .mute-btn {
      background: #fff; color: #2563eb; border: 2px solid #2563eb;
    }
    .mute-btn.active {
      background: #ef4444; color: #fff; border-color: #ef4444;
    }
    .refresh-btn:hover, .mute-btn:hover { transform: scale(1.05); }

    .notice {
      margin-top: 12px; font-size: .9rem;
      color: #f87171; background: rgba(248, 113, 113, .1);
      padding: 8px; border-radius: 6px;
      text-align: center;
    }

    /* éªŒè¯ç åˆ—è¡¨ */
    #list .item {
      position: relative; overflow: hidden;
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #3b82f6;
      margin-bottom: 12px; padding: 12px 16px 24px;
      border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: transform .3s, box-shadow .3s;
    }
    .item:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(59,130,246,0.5);
    }
    .item.highlight { border-color: #fbbf24; animation: pulse 2s infinite; }
    .line {
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
      font-size: 1rem; font-weight: 600;
    }
    .recipient {
      background: #dbeafe; color: #1e293b;
      padding: 2px 8px; border-radius: 12px; font-size: .85rem;
    }
    .code-wrapper { display: flex; align-items: center; gap: 8px; }
    .label { font-size: 1rem; }
    .code {
      font-size: 1.5rem; font-weight: 800; letter-spacing: 1px;
      color: #3b82f6; text-shadow: 0 2px 4px rgba(59,130,246,0.4);
    }
    .copy-btn {
      background: #3b82f6; color: #fff; border: none;
      padding: 6px 12px; border-radius: 6px; font-size: .85rem;
      cursor: pointer; transition: transform .2s;
    }
    .copy-btn:hover { transform: scale(1.05); }
    .copy-btn.done { background: #22c55e !important; }

    .meta {
      font-size: .8rem; color: #94a3b8;
      display: flex; align-items: center; gap: 4px;
    }

    /* Chart.js å›¾è¡¨ */
    #chart-container {
      margin: 20px auto; max-width: 400px;
      background: rgba(255,255,255,0.1); padding: 12px;
      border-radius: 12px; text-align: center;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(251,191,36,0.4) }
      70% { box-shadow: 0 0 0 10px rgba(251,191,36,0) }
      100% { box-shadow: 0 0 0 0 rgba(251,191,36,0) }
    }

    /* â€”â€” ç§»åŠ¨ç«¯é€‚é… â€”â€” */
    @media (max-width: 600px) {
      .header h1 { font-size: 1.5rem; }
      .controls { flex-direction: column; }
      #particles-js, #glsl-canvas, #tsparticles { display: none; }
      #chart-container { max-width: 100%; }
    }
  </style>
</head>
<body data-barba="wrapper">
  <!-- ç²’å­èƒŒæ™¯ -->
  <div id="particles-js"></div>
  <!-- GLSL èƒŒæ™¯ -->
  <canvas id="glsl-canvas"></canvas>
  <!-- é¼ æ ‡å°¾è¿¹ -->
  <div id="tsparticles"></div>

  <div class="container" data-barba="container" data-barba-namespace="home">
    <div class="header" id="tilt-area">
      <!-- SVG Logo + æ‰‹ç»˜åŠ¨ç”» -->
      <svg id="logo" width="200" height="60" xmlns="http://www.w3.org/2000/svg">
        <text x="0" y="50" font-family="Segoe UI" font-size="48" fill="none" stroke="#2563eb" stroke-width="1">
          éªŒè¯ç åˆ—è¡¨
        </text>
      </svg>
      <h1>éªŒè¯ç åˆ—è¡¨</h1>

      <div class="controls">
        <button class="mute-btn" id="muteBtn">ğŸ”Š</button>
        <button class="refresh-btn" id="refreshBtn">
          ğŸ”„ åˆ·æ–°
        </button>
      </div>
      <div class="notice">å¦‚æœéªŒè¯ç ä¸€ç›´æ²¡æ¥è¯·è”ç³» AÂ Kun</div>
    </div>

    <!-- Sparkline å›¾è¡¨ -->
    <div id="chart-container">
      <canvas id="chart"></canvas>
    </div>

    <!-- éªŒè¯ç åˆ—è¡¨ -->
    <div id="list">
      <div class="item empty">
        æ­£åœ¨åŠ è½½éªŒè¯ç æ•°æ®ï¼Œè¯·ç¨å€™...
      </div>
    </div>
  </div>

  <!-- â€”â€” è„šæœ¬ä¾èµ– â€”â€” -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/glsl-canvas-js/dist/glslCanvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.0/dist/vanilla-tilt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vivus@0.4.6/dist/vivus.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/Physics2DPlugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.7.4/tsparticles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@barba/core@2.9.7/dist/barba.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rellax@1.12.1/rellax.min.js"></script>

  <script>
    /* â€”â€” ç²’å­èƒŒæ™¯ â€”â€” */
    particlesJS('particles-js', {
      particles: {
        number: { value: 60 },
        color: { value: '#3b82f6' },
        shape: { type: 'circle' },
        opacity: { value: 0.5 },
        size: { value: 3 },
        line_linked: { enable: true, distance: 150, color: '#3b82f6' },
        move: { enable: true, speed: 1 }
      },
      interactivity: {
        events: { onhover: { enable: true, mode: 'repulse' } }
      }
    });

    /* â€”â€” GLSL æµä½“æ•ˆæœ â€”â€” */
    new GlslCanvas(document.getElementById('glsl-canvas'), {
      fragment: `
        precision mediump float;
        uniform vec2 RENDERSIZE;
        uniform float TIME;
        // ç®€æ˜“æµåŠ¨å™ªå£°
        float n(float x) { return fract(sin(x*12.9898+TIME)*43758.5453); }
        void main(){
          vec2 uv = gl_FragCoord.xy/RENDERSIZE.xy;
          float v = n(uv.x*10.0)*0.5 + n(uv.y*10.0)*0.5;
          vec3 col = mix(vec3(0.05,0.1,0.2), vec3(0.2,0.4,0.8), v);
          gl_FragColor = vec4(col, 0.6);
        }
      `
    });

    /* â€”â€” Vanilla Tilt æµ®åŠ¨ â€”â€” */
    VanillaTilt.init(document.getElementById('tilt-area'), {
      max: 15, speed: 400, glare: true, "max-glare": 0.3
    });

    /* â€”â€” Vivus æ‰‹ç»˜ Logo â€”â€” */
    new Vivus('logo', { type: 'delayed', duration: 200, animTimingFunction: Vivus.EASE });

    /* â€”â€” å±€éƒ¨æ»šåŠ¨è§¦å‘ç²’å­æ•£å°„ â€”â€” */
    gsap.registerPlugin(ScrollTrigger, Physics2DPlugin);
    gsap.utils.toArray('.item').forEach(item => {
      ScrollTrigger.create({
        trigger: item,
        start: 'top 80%',
        onEnter: () => {
          gsap.to(item, {
            duration: 0.6, opacity: 0,
            physics2D: { velocity:150, angle:90, gravity:300 }
          });
        }
      });
    });

    /* â€”â€” Chart.js Sparkline â€”â€” */
    const ctx = document.getElementById('chart').getContext('2d');
    const spark = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ data: [], fill: false, tension: 0.3 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false }, y: { display: false }
        },
        elements: { point: { radius: 0 } }
      }
    });

    /* â€”â€” é¼ æ ‡å°¾è¿¹ â€”â€” */
    tsParticles.load('tsparticles', {
      fpsLimit: 60,
      particles: {
        number: { value: 0 },
        move: { enable: true, speed: 3, outModes: 'destroy' },
        shape: { type: 'circle' },
        size: { value: { min: 1, max: 3 } },
        opacity: { value: 1, anim: { enable: true, speed: 1, minimumValue: 0.1 } }
      },
      interactivity: {
        events: { onHover: { enable: true, mode: 'trail' } },
        modes: { trail: { delay: 0.005, quantity: 5 } }
      },
      detectRetina: true
    });

    /* â€”â€” Barba.js é¡µé¢è¿‡æ¸¡ â€”â€” */
    barba.init({
      transitions: [{
        leave() { return gsap.to('.container', { opacity: 0, duration: 0.3 }); },
        enter() { return gsap.from('.container', { opacity: 0, duration: 0.3 }); }
      }]
    });

    /* â€”â€” Rellax 3D è§†å·® â€”â€” */
    new Rellax('.item', { speed: -2, center: true, round: true });

    /* â€”â€” ä¸»é€»è¾‘ï¼šè·å–éªŒè¯ç  & è¯­éŸ³æ’­æŠ¥ & å›¾è¡¨æ›´æ–° â€”â€” */
    const apiURL = 'https://script.google.com/macros/s/AKfycbz7MCmkGY9gzlk7pvYCbgM-0hShzxrW5n9pBRCMavFV0z6baPgsnwJ06MT5KOf94we_/exec';
    let lastHash = null, isMuted = false;

    document.getElementById('muteBtn').addEventListener('click', () => {
      isMuted = !isMuted;
      document.getElementById('muteBtn').classList.toggle('active', isMuted);
      document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    });
    document.getElementById('refreshBtn').addEventListener('click', () => location.reload());

    function announce(code) {
      if (!isMuted && 'speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(`æ”¶åˆ°æ–°éªŒè¯ç  ${code}`);
        speechSynthesis.speak(msg);
      }
      if (Notification.permission === 'granted') {
        new Notification('æ–°éªŒè¯ç ', { body: code });
      }
    }
    // è¯·æ±‚æ¡Œé¢é€šçŸ¥æƒé™
    if ('Notification' in window) Notification.requestPermission();

    function hashData(data) {
      return data.slice(0,10).map(i=>i['éªŒè¯ç ']+'|'+i['æ¥æ”¶æ—¶é—´']).join(',').split('').reduce((h,c)=>((h<<5)-h)+c.charCodeAt(0)|0,0);
    }

    function updateChart(data) {
      const arr = data.map(i=>Number(i['æ¥æ”¶æ—¶é—´'])||0).slice(-10);
      spark.data.labels = arr.map((_,i)=>`#${i+1}`);
      spark.data.datasets[0].data = arr;
      spark.update();
    }

    function renderList(data) {
      const list = document.getElementById('list');
      const filtered = data.filter(i=>i['é‚®ä»¶ä¸»é¢˜']?.includes('ã€GENDA IDã€‘èªè¨¼ã‚³ãƒ¼ãƒ‰'));
      if (!filtered.length) {
        list.innerHTML = '<div class="item empty">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®â€¦</div>';
        return;
      }
      const bg = `hsl(${Math.random()*360},70%,90%)`;
      list.innerHTML = filtered.slice(0,10).map((i, idx) => `
        <div class="item ${idx===0?'highlight':''}" ${idx===0?`style="background:linear-gradient(to right,${bg},#fffdf0)"`:''}>
          <div class="line">
            <span class="recipient">${i['æ”¶ä»¶äºº']||'æœªçŸ¥'}</span>
            <div class="code-wrapper">
              <span class="label">éªŒè¯ç ï¼š</span>
              ${i['éªŒè¯ç ']!=='-'?`<span class="code">${i['éªŒè¯ç ']}</span>
                <button class="copy-btn" data-code="${i['éªŒè¯ç ']}">å¤åˆ¶</button>`
              : `<span class="code">(æœªæ‰¾åˆ°)</span>`}
            </div>
          </div>
          <div class="meta">âŒš ${new Date(i['æ¥æ”¶æ—¶é—´']).toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'})}</div>
        </div>
      `).join('');
      document.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          try{ await navigator.clipboard.writeText(btn.dataset.code);
            btn.textContent='å·²å¤åˆ¶'; btn.classList.add('done');
            setTimeout(()=>{btn.textContent='å¤åˆ¶';btn.classList.remove('done');},2000);
          }catch{ alert('å¤åˆ¶å¤±è´¥ï¼š'+btn.dataset.code); }
        });
      });
    }

    async function loadData() {
      try {
        const res = await fetch(apiURL, { cache:'no-cache' });
        const json = await res.json();
        if (json.status==='OK' && Array.isArray(json.data)) {
          const h = hashData(json.data);
          if (h!==lastHash) {
            const first = json.data.find(i=>i['é‚®ä»¶ä¸»é¢˜']?.includes('ã€GENDA IDã€‘èªè¨¼ã‚³ãƒ¼ãƒ‰'));
            if (first && first['éªŒè¯ç ']!=='-') announce(first['éªŒè¯ç ']);
            renderList(json.data);
            updateChart(json.data);
            lastHash = h;
          }
        }
      } catch(e) { console.error(e); }
    }

    loadData();
    setInterval(loadData, 2000);
    document.addEventListener('visibilitychange',()=> {
      if (document.visibilityState==='visible') loadData();
    });
  </script>
</body>
</html>
