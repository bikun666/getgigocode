<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>éªŒè¯ç åˆ—è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
      color: #1e293b;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      padding: 20px; min-height: 100vh;
    }
    .container { max-width: 800px; margin: 0 auto; animation: fadeIn 0.5s ease-out; }
    .header {
      background: #fff; border-radius: 16px; box-shadow: 0 6px 20px rgba(59,130,246,0.15);
      padding: 20px 30px; margin-bottom: 24px; border: 1px solid #dbeafe;
    }
    .header-top {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
    }
    .header h1 {
      font-size: 24px; font-weight: 800; color: #2563eb;
      background: linear-gradient(90deg, #3b82f6,#1d4ed8);
      -webkit-background-clip: text; background-clip: text;
      -webkit-text-fill-color: transparent; white-space: nowrap;
    }
    .controls { display: flex; align-items: center; gap: 12px; }
    .refresh-btn {
      background: #3b82f6; color: #fff; border: none; border-radius: 10px;
      padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.3s; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 6px rgba(59,130,246,0.3);
    }
    .refresh-btn:hover {
      background: #2563eb; transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(59,130,246,0.4);
    }
    .refresh-btn:active { transform: translateY(0); }
    .status-container {
      display: flex; align-items: center; min-height: 45px; background: #f8fafc;
      border-radius: 10px; padding: 12px 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      border-left: 3px solid #3b82f6; transition: all 0.3s ease;
    }
    .status-content { display: flex; align-items: center; width: 100%; gap: 10px; }
    .loader {
      width: 24px; height: 24px; border: 3px solid rgba(59,130,246,0.2);
      border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;
      flex-shrink: 0;
    }
    .status {
      font-size: 14px; color: #4b5563; flex-grow: 1; min-width: 160px;
    }
    .update-time {
      font-size: 13px; color: #6b7280; font-weight: 500;
      white-space: nowrap; flex-shrink: 0;
    }
    .error {
      color: #ef4444; background: #fee2e2; padding: 10px 15px;
      border-radius: 10px; display: flex; align-items: center; gap: 10px;
      width: 100%;
    }
    .item {
      background: #fff; border-left: 6px solid #3b82f6; padding: 20px;
      border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px; position: relative; transition: all 0.3s ease;
      overflow: hidden;
    }
    .item:hover {
      transform: translateY(-5px); box-shadow: 0 8px 25px rgba(59,130,246,0.2);
    }
    .item.highlight {
      background: linear-gradient(to right,#fff7b2,#fffdf0);
      border-color: #fbbf24; animation: pulse 2s infinite;
    }
    .latest-tip {
      position: absolute; top: 0; right: 0;
      background: linear-gradient(90deg,#f59e0b,#b45309);
      color: #fff; font-size: 14px; font-weight: 700;
      padding: 8px 16px; border-bottom-left-radius: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .line {
      font-size: 18px; font-weight: 600; margin-bottom: 10px;
      display: flex; align-items: center; gap: 10px; flex-wrap: nowrap;
    }
    .recipient {
      background: #dbeafe; padding: 4px 10px; border-radius: 20px;
      font-size: 15px; white-space: nowrap;
    }
    .code {
      color: #2563eb; font-weight: 800; font-size: 28px;
      letter-spacing: 2px; text-shadow: 0 2px 4px rgba(37,99,235,0.2);
      white-space: nowrap;
    }
    .copy-btn {
      background: #3b82f6; color: #fff; border: none; border-radius: 8px;
      padding: 8px 18px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: 0.3s; display: inline-flex;
      align-items: center; gap: 6px; white-space: nowrap;
    }
    .copy-btn:hover { background: #2563eb; transform: scale(1.05); }
    .copy-btn.done { background: #22c55e !important; }
    .meta {
      font-size: 14px; color: #6b7280; display: flex;
      align-items: center; gap: 8px; margin-top: 5px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(251,191,36,0.4); }
      70% { box-shadow: 0 0 0 12px rgba(251,191,36,0); }
      100% { box-shadow: 0 0 0 0 rgba(251,191,36,0); }
    }
    @media (max-width: 768px) {
      .header-top { flex-direction: column; gap: 15px; text-align: center; }
      .controls { width: 100%; justify-content: center; }
      .item { padding: 15px; }
      .line { gap: 8px; }
      .status-content { flex-wrap: wrap; }
    }
    @media (max-width: 480px) {
      body { padding: 15px; }
      .header { padding: 15px; }
      .refresh-btn { width: 100%; justify-content: center; }
      .status-container { padding: 10px 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>éªŒè¯ç åˆ—è¡¨</h1>
        <div class="controls">
          <button class="refresh-btn" id="refreshBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
              <path d="M16 16h5v5"/>
            </svg>
            åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="status-container">
        <div class="status-content">
          <div class="loader"></div>
          <div class="status">æ­£åœ¨åŠ è½½æœ€æ–°éªŒè¯ç ...</div>
          <div class="update-time" id="updateTime"></div>
        </div>
      </div>
    </div>
    <div id="list">
      <div class="item empty">
        æ­£åœ¨åŠ è½½éªŒè¯ç æ•°æ®ï¼Œè¯·ç¨å€™...
      </div>
    </div>
  </div>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbwGHCgYNwdsLZf7zZbs6TxRXZEH2s4gj2vovv_QSQ9jlrN2uefoJRkp2Ewz_cYImDKY/exec';
    let lastHash = null, lastUpdate = null, errors = 0;
    const maxErrors = 5, interval = 2000;

    function updateStatus(msg, isErr = false) {
      const sc = document.querySelector('.status-content');
      if (!sc) return;
      if (isErr) {
        sc.innerHTML = `<div class="error">åŠ è½½é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°</div>`;
      } else {
        document.querySelector('.status').textContent = msg;
        if (lastUpdate) {
          document.getElementById('updateTime').textContent =
            'æœ€åæ›´æ–°: ' + lastUpdate.toLocaleTimeString();
        }
      }
    }

    function formatDate(iso) {
      return new Date(iso)
        .toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo' });
    }

    function hashData(data) {
      if (!data.length) return '';
      const s = data.slice(0,10)
        .map(i=> (i['éªŒè¯ç ']||'')+'|'+(i['æ¥æ”¶æ—¶é—´']||''))
        .join(',');
      let h=0; for(let c of s) h=(h<<5)-h+c.charCodeAt(0),h|=0;
      return h;
    }

    function renderList(data) {
      const list = document.getElementById('list');
      const filtered = data.filter(i=>
        (i['é‚®ä»¶ä¸»é¢˜']||'').includes('ã€GENDA IDã€‘èªè¨¼ã‚³ãƒ¼ãƒ‰')
      );
      if (!filtered.length) {
        list.innerHTML = '<div class="item empty">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®â€¦</div>';
        return;
      }
      list.innerHTML = filtered.slice(0,10).map((i,idx)=>`
        <div class="item ${idx===0?'highlight':''}">
          ${idx===0?'<div class="latest-tip">ğŸŸ¡ æœ€æ–°éªŒè¯ç </div>':''}
          <div class="line">
            <span class="recipient">${i['æ”¶ä»¶äºº']||'æœªçŸ¥'}</span>
            éªŒè¯ç ï¼š
            ${i['éªŒè¯ç ']&&i['éªŒè¯ç ']!=='-'
              ? `<span class="code">${i['éªŒè¯ç ']}</span>
                 <button class="copy-btn" data-code="${i['éªŒè¯ç ']}">å¤åˆ¶</button>`
              : `<span class="code">(æœªæ‰¾åˆ°)</span>`}
          </div>
          <div class="meta">
            <svg xmlns="http://www.w3.org/2000/svg" class="meta-icon" width="16" height="16" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            ${formatDate(i['æ¥æ”¶æ—¶é—´'])}
          </div>
        </div>
      `).join('');
      document.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          const code=btn.dataset.code;
          try {
            await navigator.clipboard.writeText(code);
            btn.textContent='å·²å¤åˆ¶'; btn.classList.add('done');
            setTimeout(()=>{ btn.textContent='å¤åˆ¶';btn.classList.remove('done'); },2000);
          } catch{ alert('å¤åˆ¶å¤±è´¥ï¼š'+code); }
        });
      });
    }

    async function loadData() {
      try {
        const t0=Date.now();
        const res=await fetch(apiURL,{cache:'no-cache'});
        if(!res.ok) throw new Error(res.status);
        const json=await res.json(), dt=Date.now()-t0;
        if(json.status==='OK'&&Array.isArray(json.data)) {
          const h=hashData(json.data);
          if(h!==lastHash) {
            renderList(json.data);
            lastHash=h; lastUpdate=new Date(); errors=0;
            updateStatus(`æ•°æ®å·²æ›´æ–° (${dt}ms)`);
          } else {
            updateStatus(`æ•°æ®æœªå˜åŒ– (${dt}ms)`);
          }
        } else throw new Error('æ— æ•ˆæ•°æ®');
      } catch(e) {
        console.error(e); errors++;
        updateStatus('åŠ è½½é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°', true);
      }
    }

    document.getElementById('refreshBtn')
      .addEventListener('click',()=>{
        updateStatus('æ‰‹åŠ¨åˆ·æ–°ä¸­...');
        loadData();
      });

    loadData();
    setInterval(loadData, interval);

    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='visible') loadData();
    });
  </script>
</body>
</html>
